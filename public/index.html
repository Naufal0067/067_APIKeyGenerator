<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Generate API Key</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <style>
        body { background: #f0f2f5; }
        .card { border-radius: 15px; }
    </style>
</head>
<body>

<div class="container d-flex justify-content-center mt-5">
    <div class="card p-4 shadow" style="width: 450px;">
        <h3 class="text-center mb-3">Generate API Key</h3>

        <input id="first" class="form-control mb-2" placeholder="Nama Depan" required>
        <input id="last" class="form-control mb-2" placeholder="Nama Belakang">
        <input id="email" class="form-control mb-2" placeholder="Email" type="email" required>

        <input id="apikey" class="form-control mb-3" readonly placeholder="API Key">

        <button id="btnGen" onclick="genKey()" class="btn btn-primary w-100 mb-2">
            Generate API Key
        </button>
        <button id="btnSave" onclick="saveDB()" class="btn btn-success w-100">
            Save to Database
        </button>

        <a href="/admin.html" class="mt-3 text-center d-block">Admin Login</a>
    </div>
</div>

<script>
function genKey() {
    const key = "API-" + Math.random().toString(36).substring(2) + "-" + Date.now();
    document.getElementById("apikey").value = key;
}

async function saveDB() {

    const firstName = document.getElementById("first").value.trim();
    const lastName = document.getElementById("last").value.trim();
    const email = document.getElementById("email").value.trim();
    const apikey = document.getElementById("apikey").value.trim();
    const btn = document.getElementById("btnSave");

    if (!firstName || !email) {
        return alert("Nama Depan dan Email wajib diisi.");
    }

    if (!apikey) {
        return alert("Generate API Key terlebih dahulu.");
    }

    btn.disabled = true;
    btn.innerText = "Saving...";

    const data = {
        first_name: firstName,
        last_name: lastName,
        email: email,
        apikey: apikey
    };

    try {
        // Perbaikan utama: route harus /users/create
        const res = await fetch("/users/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const response = await res.json();

        if (response.error) {
            alert("Gagal menyimpan data: " + response.msg);
        } else {
            alert("API Key berhasil disimpan!");

            document.getElementById("first").value = "";
            document.getElementById("last").value = "";
            document.getElementById("email").value = "";
            document.getElementById("apikey").value = "";
        }
    } catch(e) {
        alert("Server error / tidak bisa terhubung.");
    }

    btn.disabled = false;
    btn.innerText = "Save";
}
</script>

</body>
</html>
